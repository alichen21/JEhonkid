<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸Šä¼ å›¾ç‰‡ - äº²å­æ—¥è¯­å¯ç†è§£è¾“å…¥åŠ©æ‰‹</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .upload-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .upload-area {
            border: 3px dashed #4CAF50;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background-color: #f9f9f9;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }
        
        .upload-area:hover {
            background-color: #f0f0f0;
            border-color: #45a049;
        }
        
        .upload-area.dragover {
            background-color: #e8f5e9;
            border-color: #4CAF50;
        }
        
        .upload-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .upload-text {
            font-size: 18px;
            color: #333;
            margin-bottom: 10px;
        }
        
        .upload-hint {
            font-size: 14px;
            color: #666;
        }
        
        #file-input {
            display: none;
        }
        
        .preview-section {
            margin-top: 20px;
            display: none;
        }
        
        .preview-image {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .btn {
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: #45a049;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .button-group .btn {
            flex: 1;
            margin-top: 0;
        }
        
        @media (max-width: 600px) {
            .button-group {
                flex-direction: column;
            }
        }
        
        .progress-section {
            margin-top: 20px;
            display: none;
        }
        
        .progress-bar-container {
            width: 100%;
            height: 30px;
            background-color: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-bar {
            height: 100%;
            background-color: #4CAF50;
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }
        
        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        
        .progress-step {
            flex: 1;
            text-align: center;
            padding: 8px;
            border-radius: 6px;
            font-size: 12px;
        }
        
        .progress-step.pending {
            background-color: #f0f0f0;
            color: #999;
        }
        
        .progress-step.processing {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .progress-step.completed {
            background-color: #d4edda;
            color: #155724;
        }
        
        .result-section {
            margin-top: 20px;
            display: none;
        }
        
        .result-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
        }
        
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #4CAF50;
            text-decoration: none;
        }
        
        .back-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="upload-container">
        <a href="/" class="back-link">â† è¿”å›ä¸»é¡µ</a>
        
        <h1>ğŸ“¸ ä¸Šä¼ å›¾ç‰‡</h1>
        <p class="subtitle">æ‹ç…§æˆ–é€‰æ‹©å›¾ç‰‡è¿›è¡ŒOCRè¯†åˆ«å’Œè¯­éŸ³ç”Ÿæˆ</p>
        
        <div class="upload-area" id="upload-area">
            <div class="upload-icon">ğŸ“·</div>
            <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°è¿™é‡Œ</div>
            <div class="upload-hint">æ”¯æŒ PNG, JPG, HEIC æ ¼å¼ï¼Œæœ€å¤§ 10MB</div>
            <input type="file" id="file-input" accept="image/*" capture="environment">
            <input type="file" id="camera-input" accept="image/*" capture="environment" style="display: none;">
        </div>
        
        <div class="button-group">
            <button class="btn" id="camera-btn" style="background-color: #2196F3;">
                ğŸ“¸ æ‹ç…§
            </button>
            <button class="btn" id="gallery-btn" style="background-color: #4CAF50;">
                ğŸ–¼ï¸ é€‰æ‹©å›¾ç‰‡
            </button>
        </div>
        
        <div class="preview-section" id="preview-section">
            <h3>é¢„è§ˆ</h3>
            <img id="preview-image" class="preview-image" alt="é¢„è§ˆ">
            <button class="btn" id="upload-btn">å¼€å§‹å¤„ç†</button>
        </div>
        
        <div class="progress-section" id="progress-section">
            <h3>å¤„ç†è¿›åº¦</h3>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progress-bar">0%</div>
            </div>
            <div class="progress-steps">
                <div class="progress-step pending" id="step-ocr">
                    ğŸ“ OCRè¯†åˆ«
                </div>
                <div class="progress-step pending" id="step-text">
                    âœ¨ æ–‡æœ¬å¤„ç†
                </div>
                <div class="progress-step pending" id="step-tts">
                    ğŸ”Š è¯­éŸ³ç”Ÿæˆ
                </div>
            </div>
        </div>
        
        <div class="result-section" id="result-section">
            <h3>å¤„ç†ç»“æœ</h3>
            <div class="result-card" id="result-content">
                <!-- ç»“æœå†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            </div>
        </div>
    </div>
    
    <script>
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const cameraInput = document.getElementById('camera-input');
        const cameraBtn = document.getElementById('camera-btn');
        const galleryBtn = document.getElementById('gallery-btn');
        const previewSection = document.getElementById('preview-section');
        const previewImage = document.getElementById('preview-image');
        const uploadBtn = document.getElementById('upload-btn');
        const progressSection = document.getElementById('progress-section');
        const resultSection = document.getElementById('result-section');
        const resultContent = document.getElementById('result-content');
        
        let currentTaskId = null;
        let pollInterval = null;
        let currentFile = null;  // ä¿å­˜å½“å‰é€‰æ‹©çš„æ–‡ä»¶
        
        // æ‹ç…§æŒ‰é’®
        cameraBtn.addEventListener('click', () => {
            cameraInput.click();
        });
        
        // é€‰æ‹©å›¾ç‰‡æŒ‰é’®
        galleryBtn.addEventListener('click', () => {
            fileInput.click();
        });
        
        // ç›¸æœºè¾“å…¥å˜åŒ–
        cameraInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                currentFile = file;
                handleFile(file);
            }
        });
        
        // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸï¼ˆå…¼å®¹æ—§æ–¹å¼ï¼‰
        uploadArea.addEventListener('click', () => {
            // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            if (isMobile) {
                // ç§»åŠ¨è®¾å¤‡æ˜¾ç¤ºé€‰æ‹©èœå•
                const choice = confirm('é€‰æ‹©æ“ä½œï¼š\nç¡®å®š = æ‹ç…§\nå–æ¶ˆ = é€‰æ‹©å›¾ç‰‡');
                if (choice) {
                    cameraInput.click();
                } else {
                    fileInput.click();
                }
            } else {
                fileInput.click();
            }
        });
        
        // æ–‡ä»¶é€‰æ‹©
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                currentFile = file;  // ä¿å­˜æ–‡ä»¶å¼•ç”¨
                handleFile(file);
            }
        });
        
        // æ‹–æ‹½ä¸Šä¼ 
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) {
                currentFile = file;  // ä¿å­˜æ–‡ä»¶å¼•ç”¨
                // æ›´æ–° fileInput ä»¥ä¾¿åç»­ä½¿ç”¨
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                fileInput.files = dataTransfer.files;
                handleFile(file);
            }
        });
        
        // å¤„ç†æ–‡ä»¶
        function handleFile(file) {
            // éªŒè¯æ–‡ä»¶ç±»å‹
            const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/heic', 'image/heif'];
            if (!allowedTypes.includes(file.type) && !file.name.match(/\.(png|jpg|jpeg|heic|heif)$/i)) {
                alert('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ã€‚è¯·é€‰æ‹© PNG, JPG æˆ– HEIC æ ¼å¼çš„å›¾ç‰‡ã€‚');
                return;
            }
            
            // éªŒè¯æ–‡ä»¶å¤§å°
            if (file.size > 10 * 1024 * 1024) {
                alert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ 10MBã€‚');
                return;
            }
            
            // æ˜¾ç¤ºé¢„è§ˆ
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImage.src = e.target.result;
                previewSection.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
        
        // ä¸Šä¼ æŒ‰é’®ç‚¹å‡»
        uploadBtn.addEventListener('click', async () => {
            // ä¼˜å…ˆä½¿ç”¨ä¿å­˜çš„æ–‡ä»¶å¼•ç”¨ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä» fileInput è·å–
            const file = currentFile || fileInput.files[0];
            if (!file) {
                alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
                return;
            }
            
            // ç¦ç”¨ä¸Šä¼ æŒ‰é’®
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'ä¸Šä¼ ä¸­...';
            
            // éšè—é¢„è§ˆï¼Œæ˜¾ç¤ºè¿›åº¦
            previewSection.style.display = 'none';
            progressSection.style.display = 'block';
            resultSection.style.display = 'none';
            
            try {
                // ä¸Šä¼ æ–‡ä»¶
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'ä¸Šä¼ å¤±è´¥');
                }
                
                currentTaskId = data.task_id;
                
                // å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
                startPolling();
                
            } catch (error) {
                alert('ä¸Šä¼ å¤±è´¥: ' + error.message);
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'å¼€å§‹å¤„ç†';
                progressSection.style.display = 'none';
            }
        });
        
        // å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
        function startPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
            }
            
            pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/task/${currentTaskId}`);
                    const data = await response.json();
                    
                    if (!data.success) {
                        throw new Error(data.error || 'æŸ¥è¯¢å¤±è´¥');
                    }
                    
                    updateProgress(data);
                    
                    // å¦‚æœä»»åŠ¡å®Œæˆæˆ–å¤±è´¥ï¼Œåœæ­¢è½®è¯¢
                    if (data.status === 'completed' || data.status === 'failed') {
                        clearInterval(pollInterval);
                        pollInterval = null;
                        
                        if (data.status === 'completed') {
                            showResult(data.result);
                        } else {
                            showError(data.error || 'å¤„ç†å¤±è´¥');
                        }
                    }
                    
                } catch (error) {
                    console.error('æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥:', error);
                }
            }, 1000); // æ¯ç§’è½®è¯¢ä¸€æ¬¡
        }
        
        // æ›´æ–°è¿›åº¦æ˜¾ç¤º
        function updateProgress(data) {
            const progress = data.progress || {};
            
            // æ›´æ–°æ­¥éª¤çŠ¶æ€
            updateStep('ocr', progress.ocr);
            updateStep('text', progress.text_processing);
            updateStep('tts', progress.tts);
            
            // è®¡ç®—æ€»ä½“è¿›åº¦
            let completed = 0;
            if (progress.ocr === 'completed') completed++;
            if (progress.text_processing === 'completed') completed++;
            if (progress.tts === 'completed') completed++;
            
            const totalProgress = (completed / 3) * 100;
            const progressBar = document.getElementById('progress-bar');
            progressBar.style.width = totalProgress + '%';
            progressBar.textContent = Math.round(totalProgress) + '%';
        }
        
        // æ›´æ–°æ­¥éª¤çŠ¶æ€
        function updateStep(stepName, status) {
            const stepElement = document.getElementById(`step-${stepName}`);
            if (!stepElement) return;
            
            stepElement.className = 'progress-step';
            
            if (status === 'completed') {
                stepElement.classList.add('completed');
            } else if (status === 'processing') {
                stepElement.classList.add('processing');
            } else {
                stepElement.classList.add('pending');
            }
        }
        
        // æ˜¾ç¤ºç»“æœ
        function showResult(result) {
            resultSection.style.display = 'block';
            
            let html = '';
            
            if (result.processed_text) {
                const pt = result.processed_text;
                
                // æŒ‡å¯¼è¯­
                if (pt.instruction) {
                    html += `<div style="margin-bottom: 20px;">
                        <h4>ğŸ“‹ æŒ‡å¯¼è¯­</h4>
                        <p>${pt.instruction}</p>
                        ${result.audio_urls.instruction ? 
                            `<audio controls src="${result.audio_urls.instruction}"></audio>` : ''}
                    </div>`;
                }
                
                // æ­£æ–‡
                if (pt.main_text || pt.japanese_text) {
                    html += `<div style="margin-bottom: 20px;">
                        <h4>ğŸ“ æ­£æ–‡</h4>
                        <p style="font-size: 18px; line-height: 1.8;">${pt.main_text || pt.japanese_text}</p>
                        ${result.audio_urls.main ? 
                            `<audio controls src="${result.audio_urls.main}"></audio>` : ''}
                    </div>`;
                }
                
                // åˆ†æ®µ
                if (pt.segments && pt.segments.length > 0) {
                    html += `<div style="margin-bottom: 20px;">
                        <h4>ğŸ“– åˆ†æ®µæœ—è¯»</h4>`;
                    pt.segments.forEach((segment, idx) => {
                        html += `<div style="margin-bottom: 15px; padding: 10px; background-color: #f9f9f9; border-radius: 6px;">
                            <p style="font-size: 16px; margin-bottom: 8px;">${segment}</p>
                            ${result.audio_urls[`segment_${idx}`] ? 
                                `<audio controls src="${result.audio_urls[`segment_${idx}`]}"></audio>` : ''}
                        </div>`;
                    });
                    html += `</div>`;
                }
                
                // ä¸­æ–‡ç¿»è¯‘
                if (pt.chinese_translation) {
                    html += `<div style="margin-bottom: 20px;">
                        <h4>ğŸ‡¨ğŸ‡³ ä¸­æ–‡ç¿»è¯‘</h4>
                        <p>${pt.chinese_translation}</p>
                    </div>`;
                }
            }
            
            // OCRåŸå§‹æ–‡æœ¬
            if (result.ocr && result.ocr.full_text) {
                html += `<div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                    <h4>ğŸ“„ OCRåŸå§‹æ–‡æœ¬</h4>
                    <p style="color: #666; font-size: 14px;">${result.ocr.full_text}</p>
                </div>`;
            }
            
            html += `<div style="margin-top: 20px;">
                <button class="btn" onclick="location.reload()">å¤„ç†æ–°å›¾ç‰‡</button>
            </div>`;
            
            resultContent.innerHTML = html;
        }
        
        // æ˜¾ç¤ºé”™è¯¯
        function showError(error) {
            resultSection.style.display = 'block';
            resultContent.innerHTML = `
                <div class="error-message">
                    <strong>å¤„ç†å¤±è´¥</strong>
                    <p>${error}</p>
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn" onclick="location.reload()">é‡è¯•</button>
                </div>
            `;
        }
    </script>
</body>
</html>

