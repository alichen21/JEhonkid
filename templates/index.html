<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥è¯­ç»˜æœ¬OCRè¯†åˆ«ç»“æœ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“š æ—¥è¯­ç»˜æœ¬OCRè¯†åˆ«ç»“æœ</h1>
            <p class="subtitle">äº²å­æ—¥è¯­å¯ç†è§£è¾“å…¥åŠ©æ‰‹ - Picture to Text</p>
            <div style="margin-top: 20px;">
                <a href="/upload" style="display: inline-block; background-color: #4CAF50; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; font-size: 16px;">
                    ğŸ“¸ ä¸Šä¼ æ–°å›¾ç‰‡
                </a>
            </div>
        </header>

        <div class="stats">
            <div class="stat-card">
                <span class="stat-number">{{ total_count }}</span>
                <span class="stat-label">æ€»å›¾ç‰‡æ•°</span>
            </div>
            <div class="stat-card success">
                <span class="stat-number">{{ success_count }}</span>
                <span class="stat-label">è¯†åˆ«æˆåŠŸ</span>
            </div>
            <div class="stat-card error">
                <span class="stat-number">{{ fail_count }}</span>
                <span class="stat-label">è¯†åˆ«å¤±è´¥</span>
            </div>
        </div>

        <div class="results-grid">
            {% for result in results %}
            {% set image_index = loop.index0 %}
            <div class="result-card {% if not result.success %}error-card{% endif %}">
                <div class="card-header">
                    <h2 class="filename">
                        <span class="file-icon">ğŸ“„</span>
                        {{ result.filename }}
                    </h2>
                    {% if result.success %}
                    <span class="badge success-badge">âœ“ æˆåŠŸ</span>
                    {% else %}
                    <span class="badge error-badge">âœ— å¤±è´¥</span>
                    {% endif %}
                </div>

                <div class="card-content">
                    <div class="image-section">
                        <img src="{{ url_for('serve_image', filename=result.filename) }}" 
                             alt="{{ result.filename }}"
                             class="preview-image"
                             loading="lazy">
                    </div>

                    {% if result.success %}
                    <div class="text-section">
                        <div class="section-title">
                            <span class="icon">ğŸ“</span>
                            è¯†åˆ«æ–‡æœ¬
                        </div>
                        
                        {% if result.full_text %}
                        <div class="full-text">
                            <div class="text-label">å®Œæ•´æ–‡æœ¬ï¼š</div>
                            <div class="text-content">{{ result.full_text }}</div>
                        </div>
                        {% endif %}

                        {% if result.text_blocks %}
                        <div class="text-blocks">
                            <div class="text-label">æ–‡æœ¬å— ({{ result.text_blocks|length }}ä¸ª)ï¼š</div>
                            <div class="blocks-container">
                                {% for block in result.text_blocks %}
                                <div class="text-block">
                                    <span class="block-number">{{ loop.index }}</span>
                                    <span class="block-text">{{ block.text }}</span>
                                    {% if block.confidence %}
                                    <span class="confidence">ç½®ä¿¡åº¦: {{ "%.1f"|format(block.confidence * 100) }}%</span>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        {% if result.language %}
                        <div class="language-info">
                            <div class="text-label">æ£€æµ‹è¯­è¨€ï¼š</div>
                            <div class="languages">
                                {% for lang in result.language %}
                                <span class="language-tag">
                                    {{ lang.languageCode|upper }}
                                    <span class="confidence-small">{{ "%.0f"|format(lang.confidence * 100) }}%</span>
                                </span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        {% if result.processed_text and not result.processed_text.error %}
                        <div class="processed-section">
                            <div class="section-title">
                                <span class="icon">âœ¨</span>
                                LLMå¤„ç†ç»“æœ
                            </div>
                            
                            <!-- éš¾åº¦æ§åˆ¶é¢æ¿ -->
                            <div class="difficulty-controls" id="difficulty-controls-{{ image_index }}">
                                <div class="control-group">
                                    <label>æ¯æ®µå¥å­æ•°ï¼š</label>
                                    <select id="sentences-per-segment-{{ image_index }}" onchange="updateSegments({{ image_index }})">
                                        <option value="1">1å¥</option>
                                        <option value="2" selected>2å¥</option>
                                        <option value="3">3å¥</option>
                                        <option value="4">4å¥</option>
                                    </select>
                                </div>
                                <div class="control-group">
                                    <label>è¯­é€Ÿï¼š</label>
                                    <input type="range" id="speaking-rate-{{ image_index }}" min="0.5" max="1.5" step="0.1" value="0.75" 
                                           oninput="updateRateDisplay({{ image_index }}, this.value)">
                                    <span id="rate-display-{{ image_index }}">0.75x</span>
                                </div>
                            </div>
                            
                            <!-- æŒ‡å¯¼è¯­ -->
                            {% if result.processed_text.instruction %}
                            <div class="processed-text instruction-text">
                                <div class="text-label-with-action">
                                    <span>ğŸ“‹ æŒ‡å¯¼è¯­ï¼š</span>
                                    <button class="play-button" onclick="playSegment(this, {{ image_index }}, 'instruction')" title="æ’­æ”¾æŒ‡å¯¼è¯­">
                                        <span class="play-icon">ğŸ”Š</span>
                                        <span class="play-text">æ’­æ”¾</span>
                                    </button>
                                </div>
                                <div class="text-content instruction-content" id="instruction-text-{{ image_index }}">{{ result.processed_text.instruction }}</div>
                                <audio id="audio-instruction-{{ image_index }}" preload="none"></audio>
                            </div>
                            {% endif %}
                            
                            <!-- æ­£æ–‡ï¼ˆå®Œæ•´ï¼‰ -->
                            {% if result.processed_text.main_text %}
                            <div class="processed-text main-text">
                                <div class="text-label-with-action">
                                    <span>ğŸ“ æ­£æ–‡ï¼ˆå®Œæ•´ï¼‰ï¼š</span>
                                    <button class="play-button" onclick="playSegment(this, {{ image_index }}, 'main')" title="æ’­æ”¾å®Œæ•´æ­£æ–‡">
                                        <span class="play-icon">ğŸ”Š</span>
                                        <span class="play-text">æ’­æ”¾</span>
                                    </button>
                                </div>
                                <div class="text-content japanese-content" id="main-text-{{ image_index }}">{{ result.processed_text.main_text }}</div>
                                <audio id="audio-main-{{ image_index }}" preload="none"></audio>
                            </div>
                            {% endif %}
                            
                            <!-- åˆ†æ®µæœ—è¯» -->
                            {% if result.processed_text.segments and result.processed_text.segments|length > 0 %}
                            <div class="segments-section">
                                <div class="text-label">ğŸ“– åˆ†æ®µæœ—è¯»ï¼š</div>
                                <div class="segments-container" id="segments-container-{{ image_index }}">
                                    {% for segment in result.processed_text.segments %}
                                    {% set segment_index = loop.index0 %}
                                    <div class="segment-item">
                                        <div class="segment-header">
                                            <span class="segment-number">æ®µè½ {{ loop.index }}</span>
                                            <button class="play-button segment-play-btn" onclick="playSegment(this, {{ image_index }}, {{ segment_index }})" 
                                                    data-segment-index="{{ segment_index }}" title="æ’­æ”¾æ­¤æ®µè½">
                                                <span class="play-icon">ğŸ”Š</span>
                                                <span class="play-text">æ’­æ”¾</span>
                                            </button>
                                        </div>
                                        <div class="segment-content" id="segment-text-{{ image_index }}-{{ segment_index }}">{{ segment }}</div>
                                        <audio id="audio-segment-{{ image_index }}-{{ segment_index }}" preload="none"></audio>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- å…¼å®¹æ—§æ ¼å¼ï¼šå¦‚æœæ²¡æœ‰åˆ†æ®µä½†æœ‰japanese_text -->
                            {% if not result.processed_text.segments and result.processed_text.japanese_text %}
                            <div class="processed-text">
                                <div class="text-label-with-action">
                                    <span>ğŸ“ æ—¥è¯­æ­£æ–‡ï¼š</span>
                                    <button class="play-button" onclick="playSegment(this, {{ image_index }}, 'main')" title="æ’­æ”¾æ—¥è¯­æœ—è¯»">
                                        <span class="play-icon">ğŸ”Š</span>
                                        <span class="play-text">æ’­æ”¾</span>
                                    </button>
                                </div>
                                <div class="text-content japanese-content" id="main-text-{{ image_index }}">{{ result.processed_text.japanese_text }}</div>
                                <audio id="audio-main-{{ image_index }}" preload="none"></audio>
                            </div>
                            {% endif %}

                            {% if result.processed_text.chinese_translation %}
                            <div class="processed-text">
                                <div class="text-label">ğŸ‡¨ğŸ‡³ ä¸­æ–‡ç¿»è¯‘ï¼š</div>
                                <div class="text-content chinese-content">{{ result.processed_text.chinese_translation }}</div>
                            </div>
                            {% endif %}
                        </div>
                        {% elif result.processed_text and result.processed_text.error %}
                        <div class="processed-section error-section">
                            <div class="error-message">
                                <span class="error-icon">âš ï¸</span>
                                <div>
                                    <strong>LLMå¤„ç†å¤±è´¥</strong>
                                    <p>{{ result.processed_text.error }}</p>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="error-section">
                        <div class="error-message">
                            <span class="error-icon">âš ï¸</span>
                            <div>
                                <strong>è¯†åˆ«å¤±è´¥</strong>
                                <p>{{ result.error }}</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>

        <footer>
            <p>ä½¿ç”¨ Google Cloud Vision API è¿›è¡ŒOCRè¯†åˆ« | Google Cloud Text-to-Speech API è¿›è¡Œè¯­éŸ³åˆæˆ</p>
        </footer>
    </div>

    <script>
        // å­˜å‚¨æ¯ä¸ªå›¾ç‰‡çš„åˆ†æ®µæ•°æ®
        const segmentsData = {};
        
        // åˆå§‹åŒ–åˆ†æ®µæ•°æ®
        {% for result in results %}
        {% set image_index = loop.index0 %}
        {% if result.processed_text and not result.processed_text.error and result.processed_text.segments %}
        segmentsData[{{ image_index }}] = {{ result.processed_text.segments|tojson }};
        {% endif %}
        {% endfor %}
        
        // æ’­æ”¾æŒ‡å®šæ–‡æœ¬æ®µè½çš„éŸ³é¢‘
        async function playSegment(button, imageIndex, segmentType) {
            let text = '';
            let audioId = '';
            
            // æ ¹æ®ç±»å‹ç¡®å®šæ–‡æœ¬å’ŒéŸ³é¢‘å…ƒç´ 
            if (segmentType === 'instruction') {
                const textElement = document.getElementById(`instruction-text-${imageIndex}`);
                if (!textElement) {
                    alert('æœªæ‰¾åˆ°æŒ‡å¯¼è¯­');
                    return;
                }
                text = textElement.textContent.trim();
                audioId = `audio-instruction-${imageIndex}`;
            } else if (segmentType === 'main') {
                const textElement = document.getElementById(`main-text-${imageIndex}`);
                if (!textElement) {
                    alert('æœªæ‰¾åˆ°æ­£æ–‡');
                    return;
                }
                text = textElement.textContent.trim();
                audioId = `audio-main-${imageIndex}`;
            } else {
                // åˆ†æ®µç´¢å¼•
                const segmentIndex = parseInt(segmentType);
                const textElement = document.getElementById(`segment-text-${imageIndex}-${segmentIndex}`);
                if (!textElement) {
                    alert('æœªæ‰¾åˆ°åˆ†æ®µæ–‡æœ¬');
                    return;
                }
                text = textElement.textContent.trim();
                audioId = `audio-segment-${imageIndex}-${segmentIndex}`;
            }
            
            if (!text) {
                alert('æ–‡æœ¬å†…å®¹ä¸ºç©º');
                return;
            }
            
            const audioElement = document.getElementById(audioId);
            if (!audioElement) {
                alert('æœªæ‰¾åˆ°éŸ³é¢‘å…ƒç´ ');
                return;
            }
            
            // è·å–å½“å‰è¯­é€Ÿè®¾ç½®
            const speakingRate = parseFloat(document.getElementById(`speaking-rate-${imageIndex}`).value) || 0.75;
            
            // å¦‚æœéŸ³é¢‘å·²ç»åŠ è½½ï¼Œç›´æ¥æ’­æ”¾
            if (audioElement.src && !audioElement.ended) {
                if (audioElement.paused) {
                    audioElement.play();
                    updateButtonState(button, true);
                } else {
                    audioElement.pause();
                    updateButtonState(button, false);
                }
                return;
            }
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€ä¸ºåŠ è½½ä¸­
            button.disabled = true;
            const playIcon = button.querySelector('.play-icon');
            const playText = button.querySelector('.play-text');
            playIcon.textContent = 'â³';
            playText.textContent = 'ç”Ÿæˆä¸­...';
            
            try {
                // è°ƒç”¨TTS APIï¼Œä¼ é€’è¯­é€Ÿå‚æ•°
                const response = await fetch('/api/tts/audio', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        text: text,
                        speaking_rate: speakingRate
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'TTSæœåŠ¡é”™è¯¯');
                }
                
                // åˆ›å»ºéŸ³é¢‘URL
                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                
                // è®¾ç½®éŸ³é¢‘æº
                audioElement.src = audioUrl;
                
                // æ’­æ”¾éŸ³é¢‘
                audioElement.play();
                updateButtonState(button, true);
                
                // ç›‘å¬æ’­æ”¾ç»“æŸ
                audioElement.onended = function() {
                    updateButtonState(button, false);
                    URL.revokeObjectURL(audioUrl); // é‡Šæ”¾å†…å­˜
                };
                
                // ç›‘å¬æ’­æ”¾é”™è¯¯
                audioElement.onerror = function() {
                    alert('éŸ³é¢‘æ’­æ”¾å¤±è´¥');
                    updateButtonState(button, false);
                    button.disabled = false;
                };
                
            } catch (error) {
                console.error('TTSé”™è¯¯:', error);
                alert('ç”ŸæˆéŸ³é¢‘å¤±è´¥: ' + error.message);
                updateButtonState(button, false);
            } finally {
                button.disabled = false;
            }
        }
        
        // æ›´æ–°åˆ†æ®µæ˜¾ç¤ºï¼ˆæ ¹æ®æ¯æ®µå¥å­æ•°è®¾ç½®ï¼‰
        function updateSegments(imageIndex) {
            const sentencesPerSegment = parseInt(document.getElementById(`sentences-per-segment-${imageIndex}`).value);
            const segments = segmentsData[imageIndex];
            
            if (!segments || segments.length === 0) {
                return;
            }
            
            // é‡æ–°åˆ†æ®µé€»è¾‘
            const mainText = document.getElementById(`main-text-${imageIndex}`)?.textContent.trim() || '';
            if (!mainText) {
                return;
            }
            
            // ç®€å•çš„è‡ªåŠ¨åˆ†æ®µï¼šæŒ‰å¥å·ã€é—®å·ã€æ„Ÿå¹å·åˆ†å‰²
            const sentences = mainText.split(/([ã€‚ï¼ï¼Ÿ\n])/).filter(s => s.trim());
            const newSegments = [];
            let currentSegment = '';
            let sentenceCount = 0;
            
            for (let i = 0; i < sentences.length; i += 2) {
                if (i < sentences.length) {
                    let sentence = sentences[i].trim();
                    if (i + 1 < sentences.length) {
                        sentence += sentences[i + 1];
                    }
                    
                    if (sentence) {
                        if (currentSegment) {
                            currentSegment += sentence;
                        } else {
                            currentSegment = sentence;
                        }
                        sentenceCount++;
                        
                        if (sentenceCount >= sentencesPerSegment) {
                            newSegments.push(currentSegment.trim());
                            currentSegment = '';
                            sentenceCount = 0;
                        }
                    }
                }
            }
            
            if (currentSegment.trim()) {
                newSegments.push(currentSegment.trim());
            }
            
            // æ›´æ–°æ˜¾ç¤º
            const container = document.getElementById(`segments-container-${imageIndex}`);
            if (container) {
                container.innerHTML = '';
                newSegments.forEach((segment, index) => {
                    const segmentDiv = document.createElement('div');
                    segmentDiv.className = 'segment-item';
                    segmentDiv.innerHTML = `
                        <div class="segment-header">
                            <span class="segment-number">æ®µè½ ${index + 1}</span>
                            <button class="play-button segment-play-btn" onclick="playSegment(this, ${imageIndex}, ${index})" 
                                    data-segment-index="${index}" title="æ’­æ”¾æ­¤æ®µè½">
                                <span class="play-icon">ğŸ”Š</span>
                                <span class="play-text">æ’­æ”¾</span>
                            </button>
                        </div>
                        <div class="segment-content" id="segment-text-${imageIndex}-${index}">${segment}</div>
                        <audio id="audio-segment-${imageIndex}-${index}" preload="none"></audio>
                    `;
                    container.appendChild(segmentDiv);
                });
            }
        }
        
        // æ›´æ–°è¯­é€Ÿæ˜¾ç¤º
        function updateRateDisplay(imageIndex, rate) {
            const display = document.getElementById(`rate-display-${imageIndex}`);
            if (display) {
                display.textContent = parseFloat(rate).toFixed(1) + 'x';
            }
        }
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        function updateButtonState(button, isPlaying) {
            const playIcon = button.querySelector('.play-icon');
            const playText = button.querySelector('.play-text');
            
            if (isPlaying) {
                playIcon.textContent = 'â¸ï¸';
                playText.textContent = 'æš‚åœ';
                button.classList.add('playing');
            } else {
                playIcon.textContent = 'ğŸ”Š';
                playText.textContent = 'æ’­æ”¾';
                button.classList.remove('playing');
            }
        }
        
        // å…¼å®¹æ—§å‡½æ•°å
        function playJapaneseText(button, index) {
            playSegment(button, index, 'main');
        }
    </script>
</body>
</html>

